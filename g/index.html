<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Прыг-Скок - Тапающая игра</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 500px;
            max-height: 900px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }

        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: block;
        }

        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .ui-panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            backdrop-filter: blur(5px);
            pointer-events: auto;
        }

        #stats {
            top: 15px;
            left: 15px;
            gap: 15px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat i {
            font-size: 1.4rem;
        }

        #coins-stat i {
            color: #ffd700;
        }

        #lives-stat i {
            color: #ff4d6d;
        }

        #power-stat i {
            color: #00ccff;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            min-width: 40px;
        }

        #combo-container {
            top: 15px;
            right: 15px;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #combo-text {
            font-size: 1.1rem;
            color: #ffd700;
        }

        #combo-count {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ff9e00;
            text-shadow: 0 0 10px rgba(255, 158, 0, 0.7);
        }

        #level-indicator {
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 20px;
            font-size: 1.2rem;
            font-weight: bold;
            background: rgba(106, 13, 173, 0.8);
        }

        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            transition: opacity 0.5s;
            padding: 20px;
            text-align: center;
        }

        #game-over, #level-complete {
            opacity: 0;
            pointer-events: none;
        }

        .game-screen h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #ff9e00, #ff0058);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .game-screen p {
            font-size: 1.2rem;
            margin-bottom: 30px;
            text-align: center;
            max-width: 90%;
            line-height: 1.5;
            color: #ccc;
        }

        .stats-summary {
            display: flex;
            gap: 25px;
            margin: 20px 0 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-summary {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .stat-summary i {
            font-size: 2rem;
        }

        .stat-summary .value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .btn {
            background: linear-gradient(to right, #6a0dad, #9d4edd);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            padding: 15px 40px;
            margin: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            pointer-events: auto;
            box-shadow: 0 5px 15px rgba(106, 13, 173, 0.4);
            font-family: inherit;
        }

        .btn:hover, .btn:active {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(106, 13, 173, 0.6);
        }

        .btn i {
            margin-right: 10px;
        }

        #pause-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            z-index: 3;
            pointer-events: auto;
            padding: 0;
        }

        #controls-hint {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            text-align: center;
            backdrop-filter: blur(5px);
            animation: pulse 2s infinite;
            pointer-events: none;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .bounce {
            animation: bounce 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.3s ease;
        }

        .power-active {
            color: #00ccff !important;
            text-shadow: 0 0 10px rgba(0, 204, 255, 0.7);
        }

        @media (max-width: 500px) {
            .game-screen h1 {
                font-size: 2.2rem;
            }
            
            .btn {
                padding: 12px 30px;
                font-size: 1.1rem;
            }
            
            .stat-value {
                font-size: 1.1rem;
            }
            
            #game-container {
                border-radius: 0;
                max-height: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        
        <div id="ui">
            <div class="ui-panel" id="stats">
                <div class="stat" id="coins-stat">
                    <i class="fas fa-coins"></i>
                    <span class="stat-value" id="coins-value">0</span>
                </div>
                <div class="stat" id="lives-stat">
                    <i class="fas fa-heart"></i>
                    <span class="stat-value" id="lives-value">3</span>
                </div>
                <div class="stat" id="power-stat">
                    <i class="fas fa-bolt"></i>
                    <span class="stat-value" id="power-value">0%</span>
                </div>
            </div>
            
            <div class="ui-panel" id="combo-container">
                <div id="combo-text">КОМБО</div>
                <div id="combo-count">x1</div>
            </div>
            
            <div class="ui-panel" id="level-indicator">
                Уровень <span id="current-level">1</span>
            </div>
            
            <button class="btn ui-panel" id="pause-btn">
                <i class="fas fa-pause"></i>
            </button>
            
            <div id="controls-hint">
                Тапайте, чтобы прыгать!
            </div>
        </div>
        
        <div id="game-start" class="game-screen">
            <h1>ПРЫГ-СКОК</h1>
            <p>Тапайте по экрану, чтобы прыгать, собирайте монетки и избегайте препятствий!</p>
            <div class="stats-summary">
                <div class="stat-summary">
                    <i class="fas fa-flag"></i>
                    <div class="value" id="total-levels">3</div>
                    <div class="label">Уровней</div>
                </div>
                <div class="stat-summary">
                    <i class="fas fa-coins"></i>
                    <div class="value" id="total-coins">0</div>
                    <div class="label">Монет</div>
                </div>
            </div>
            <button class="btn" id="start-btn">
                <i class="fas fa-play"></i> НАЧАТЬ ИГРУ
            </button>
            <button class="btn" id="levels-btn">
                <i class="fas fa-list"></i> ВЫБОР УРОВНЯ
            </button>
        </div>
        
        <div id="game-over" class="game-screen">
            <h1>ИГРА ОКОНЧЕНА</h1>
            <p>Вы прошли <span id="final-level">1</span> уровень и собрали <span id="final-coins">0</span> монет!</p>
            <div class="stats-summary">
                <div class="stat-summary">
                    <i class="fas fa-coins"></i>
                    <div class="value" id="gameover-coins">0</div>
                    <div class="label">Монет</div>
                </div>
                <div class="stat-summary">
                    <i class="fas fa-bolt"></i>
                    <div class="value" id="max-combo">x1</div>
                    <div class="label">Макс. комбо</div>
                </div>
            </div>
            <button class="btn" id="restart-btn">
                <i class="fas fa-redo"></i> ИГРАТЬ СНОВА
            </button>
            <button class="btn" id="menu-btn">
                <i class="fas fa-home"></i> МЕНЮ
            </button>
        </div>
        
        <div id="level-complete" class="game-screen">
            <h1>УРОВЕНЬ ПРОЙДЕН!</h1>
            <p>Уровень <span id="completed-level">1</span> завершен!</p>
            <div class="stats-summary">
                <div class="stat-summary">
                    <i class="fas fa-coins"></i>
                    <div class="value" id="level-coins">0</div>
                    <div class="label">Монет собрано</div>
                </div>
                <div class="stat-summary">
                    <i class="fas fa-star"></i>
                    <div class="value" id="level-score">100</div>
                    <div class="label">Очки</div>
                </div>
            </div>
            <button class="btn" id="next-level-btn">
                <i class="fas fa-arrow-right"></i> СЛЕДУЮЩИЙ УРОВЕНЬ
            </button>
            <button class="btn" id="level-menu-btn">
                <i class="fas fa-home"></i> МЕНЮ
            </button>
        </div>
    </div>

    <script>
        // Основные элементы DOM
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // Состояние игры
        let gameState = 'start'; // start, playing, paused, gameover, levelcomplete
        let currentLevel = 1;
        let coins = 0;
        let lives = 3;
        let power = 0;
        let combo = 1;
        let maxCombo = 1;
        let comboTime = 0;
        let isPowerActive = false;
        let powerActiveTime = 0;
        
        // Размеры canvas
        function resizeCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
        }
        
        // Игрок
        const player = {
            x: 100,
            y: 0,
            width: 60,
            height: 80,
            velocityY: 0,
            gravity: 0.8,
            jumpForce: -16,
            color: '#FF4757',
            isJumping: false,
            groundY: 0
        };
        
        // Элементы уровня
        let platforms = [];
        let coinsList = [];
        let obstacles = [];
        let powerUps = [];
        
        // Параметры игры
        let gameSpeed = 5;
        let levelProgress = 0;
        let levelLength = 3000;
        
        // Инициализация уровня
        function initLevel(levelNum) {
            const level = levels[levelNum - 1];
            if (!level) return false;
            
            // Копируем данные уровня
            platforms = JSON.parse(JSON.stringify(level.platforms));
            coinsList = JSON.parse(JSON.stringify(level.coins));
            obstacles = JSON.parse(JSON.stringify(level.obstacles));
            powerUps = JSON.parse(JSON.stringify(level.powerUps));
            levelLength = level.length;
            levelProgress = 0;
            
            // Находим начальную позицию для игрока (первая платформа)
            player.groundY = canvas.height - 100;
            if (platforms.length > 0) {
                player.groundY = platforms[0].y - player.height;
            }
            
            // Сброс позиции игрока
            player.x = 100;
            player.y = player.groundY;
            player.velocityY = 0;
            
            currentLevel = levelNum;
            document.getElementById('current-level').textContent = currentLevel;
            
            return true;
        }
        
        // Редактор уровней
        const levels = [
            {
                name: "Начальный уровень",
                platforms: [
                    { x: 0, y: canvas.height - 100, width: 400, height: 20 },
                    { x: 500, y: canvas.height - 150, width: 300, height: 20 },
                    { x: 900, y: canvas.height - 200, width: 300, height: 20 },
                    { x: 1300, y: canvas.height - 100, width: 400, height: 20 },
                    { x: 1800, y: canvas.height - 250, width: 300, height: 20 },
                    { x: 2200, y: canvas.height - 150, width: 400, height: 20 }
                ],
                coins: [
                    { x: 250, y: canvas.height - 160 },
                    { x: 300, y: canvas.height - 160 },
                    { x: 350, y: canvas.height - 160 },
                    { x: 600, y: canvas.height - 210 },
                    { x: 650, y: canvas.height - 210 },
                    { x: 1000, y: canvas.height - 260 },
                    { x: 1050, y: canvas.height - 260 },
                    { x: 1400, y: canvas.height - 160 },
                    { x: 1450, y: canvas.height - 160 },
                    { x: 1900, y: canvas.height - 310 },
                    { x: 1950, y: canvas.height - 310 }
                ],
                obstacles: [
                    { x: 800, y: canvas.height - 120, width: 40, height: 80 },
                    { x: 1200, y: canvas.height - 120, width: 40, height: 80 },
                    { x: 1700, y: canvas.height - 120, width: 40, height: 80 }
                ],
                powerUps: [
                    { x: 1600, y: canvas.height - 300, type: 'superJump' }
                ],
                length: 2600
            },
            {
                name: "Парящие платформы",
                platforms: [
                    { x: 0, y: canvas.height - 100, width: 300, height: 20 },
                    { x: 400, y: canvas.height - 200, width: 200, height: 20 },
                    { x: 700, y: canvas.height - 300, width: 200, height: 20 },
                    { x: 1000, y: canvas.height - 200, width: 200, height: 20 },
                    { x: 1300, y: canvas.height - 100, width: 300, height: 20 },
                    { x: 1700, y: canvas.height - 250, width: 250, height: 20 },
                    { x: 2050, y: canvas.height - 350, width: 250, height: 20 },
                    { x: 2400, y: canvas.height - 200, width: 300, height: 20 }
                ],
                coins: [
                    { x: 450, y: canvas.height - 260 },
                    { x: 500, y: canvas.height - 260 },
                    { x: 750, y: canvas.height - 360 },
                    { x: 800, y: canvas.height - 360 },
                    { x: 1050, y: canvas.height - 260 },
                    { x: 1100, y: canvas.height - 260 },
                    { x: 1750, y: canvas.height - 310 },
                    { x: 1800, y: canvas.height - 310 },
                    { x: 2100, y: canvas.height - 410 },
                    { x: 2150, y: canvas.height - 410 },
                    { x: 2450, y: canvas.height - 260 },
                    { x: 2500, y: canvas.height - 260 }
                ],
                obstacles: [
                    { x: 350, y: canvas.height - 120, width: 40, height: 80 },
                    { x: 900, y: canvas.height - 220, width: 40, height: 80 },
                    { x: 1600, y: canvas.height - 120, width: 40, height: 80 },
                    { x: 2300, y: canvas.height - 120, width: 40, height: 80 }
                ],
                powerUps: [
                    { x: 1500, y: canvas.height - 350, type: 'shield' },
                    { x: 1950, y: canvas.height - 450, type: 'superJump' }
                ],
                length: 2800
            },
            {
                name: "Сложные препятствия",
                platforms: [
                    { x: 0, y: canvas.height - 100, width: 400, height: 20 },
                    { x: 500, y: canvas.height - 180, width: 300, height: 20 },
                    { x: 900, y: canvas.height - 100, width: 200, height: 20 },
                    { x: 1200, y: canvas.height - 220, width: 300, height: 20 },
                    { x: 1600, y: canvas.height - 140, width: 200, height: 20 },
                    { x: 1900, y: canvas.height - 280, width: 300, height: 20 },
                    { x: 2300, y: canvas.height - 180, width: 400, height: 20 }
                ],
                coins: [
                    { x: 550, y: canvas.height - 240 },
                    { x: 600, y: canvas.height - 240 },
                    { x: 1250, y: canvas.height - 280 },
                    { x: 1300, y: canvas.height - 280 },
                    { x: 1950, y: canvas.height - 340 },
                    { x: 2000, y: canvas.height - 340 },
                    { x: 2350, y: canvas.height - 240 },
                    { x: 2400, y: canvas.height - 240 },
                    { x: 2450, y: canvas.height - 240 }
                ],
                obstacles: [
                    { x: 450, y: canvas.height - 120, width: 40, height: 80 },
                    { x: 850, y: canvas.height - 120, width: 40, height: 80 },
                    { x: 1150, y: canvas.height - 120, width: 40, height: 80 },
                    { x: 1550, y: canvas.height - 120, width: 40, height: 80 },
                    { x: 1850, y: canvas.height - 120, width: 40, height: 80 },
                    { x: 2250, y: canvas.height - 120, width: 40, height: 80 }
                ],
                powerUps: [
                    { x: 1700, y: canvas.height - 300, type: 'magnet' }
                ],
                length: 2700
            }
        ];
        
        // Рисование
        function drawBackground() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0f3460');
            gradient.addColorStop(1, '#1a1a2e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Звезды
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 100; i++) {
                const x = (i * 37 + levelProgress * 0.1) % canvas.width;
                const y = (i * 23) % canvas.height;
                const size = Math.random() * 2 + 1;
                ctx.fillRect(x, y, size, size);
            }
        }
        
        function drawPlatforms() {
            platforms.forEach(platform => {
                const platformX = platform.x - levelProgress;
                
                if (platformX + platform.width > 0 && platformX < canvas.width) {
                    const gradient = ctx.createLinearGradient(
                        platformX, platform.y, 
                        platformX, platform.y + platform.height
                    );
                    gradient.addColorStop(0, '#9D4EDD');
                    gradient.addColorStop(1, '#7B2CBF');
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(platformX, platform.y, platform.width, platform.height);
                    
                    // Текстура
                    ctx.fillStyle = '#C77DFF';
                    for (let i = 0; i < platform.width; i += 20) {
                        ctx.fillRect(platformX + i, platform.y, 10, 3);
                    }
                }
            });
        }
        
        function drawCoins() {
            coinsList.forEach(coin => {
                const coinX = coin.x - levelProgress;
                
                if (coinX > 0 && coinX < canvas.width) {
                    ctx.save();
                    ctx.translate(coinX + 15, coin.y + 15);
                    
                    // Вращение
                    const rotation = Date.now() * 0.005;
                    ctx.rotate(rotation);
                    
                    // Градиент
                    const gradient = ctx.createRadialGradient(0, 0, 5, 0, 0, 15);
                    gradient.addColorStop(0, '#FFD700');
                    gradient.addColorStop(1, '#FFA500');
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(0, 0, 15, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Буква C
                    ctx.fillStyle = '#B8860B';
                    ctx.font = 'bold 18px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('C', 0, 0);
                    
                    ctx.restore();
                }
            });
        }
        
        function drawObstacles() {
            obstacles.forEach(obstacle => {
                const obstacleX = obstacle.x - levelProgress;
                
                if (obstacleX + obstacle.width > 0 && obstacleX < canvas.width) {
                    const gradient = ctx.createLinearGradient(
                        obstacleX, obstacle.y,
                        obstacleX + obstacle.width, obstacle.y + obstacle.height
                    );
                    gradient.addColorStop(0, '#FF4D6D');
                    gradient.addColorStop(1, '#C9184A');
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(obstacleX, obstacle.y, obstacle.width, obstacle.height);
                    
                    // Шипы
                    ctx.fillStyle = '#FF8FA3';
                    const spikeCount = Math.floor(obstacle.width / 15);
                    for (let i = 0; i < spikeCount; i++) {
                        const x = obstacleX + i * 15 + 7;
                        ctx.beginPath();
                        ctx.moveTo(x, obstacle.y);
                        ctx.lineTo(x + 5, obstacle.y - 10);
                        ctx.lineTo(x + 10, obstacle.y);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
            });
        }
        
        function drawPowerUps() {
            powerUps.forEach(powerUp => {
                const powerUpX = powerUp.x - levelProgress;
                
                if (powerUpX > 0 && powerUpX < canvas.width) {
                    ctx.save();
                    ctx.translate(powerUpX + 20, powerUp.y + 20);
                    
                    // Пульсация
                    const pulse = Math.sin(Date.now() * 0.005) * 5;
                    
                    // Градиент по типу
                    let gradient, icon;
                    if (powerUp.type === 'superJump') {
                        gradient = ctx.createRadialGradient(0, 0, 10, 0, 0, 20 + pulse);
                        gradient.addColorStop(0, '#00FFAA');
                        gradient.addColorStop(1, '#00CC88');
                        icon = '⬆';
                    } else if (powerUp.type === 'shield') {
                        gradient = ctx.createRadialGradient(0, 0, 10, 0, 0, 20 + pulse);
                        gradient.addColorStop(0, '#00AAFF');
                        gradient.addColorStop(1, '#0088CC');
                        icon = '⛊';
                    } else {
                        gradient = ctx.createRadialGradient(0, 0, 10, 0, 0, 20 + pulse);
                        gradient.addColorStop(0, '#FFAA00');
                        gradient.addColorStop(1, '#CC8800');
                        icon = '↯';
                    }
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(0, 0, 20 + pulse, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Иконка
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(icon, 0, 0);
                    
                    ctx.restore();
                }
            });
        }
        
        function drawPlayer() {
            // Тело
            ctx.fillStyle = isPowerActive ? '#00CCFF' : player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // Глаза
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(player.x + 15, player.y + 15, 10, 10);
            ctx.fillRect(player.x + 35, player.y + 15, 10, 10);
            
            // Улыбка
            ctx.beginPath();
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 3;
            ctx.arc(player.x + 30, player.y + 40, 15, 0.2, 0.8 * Math.PI);
            ctx.stroke();
            
            // Эффект силы
            if (isPowerActive) {
                ctx.strokeStyle = '#00CCFF';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(
                    player.x + player.width/2, 
                    player.y + player.height/2, 
                    player.width, 
                    0, 
                    Math.PI * 2
                );
                ctx.stroke();
            }
        }
        
        // Логика игры
        function updatePlayer() {
            // Гравитация
            player.velocityY += player.gravity;
            player.y += player.velocityY;
            
            // Проверка падения
            if (player.y > canvas.height) {
                loseLife();
                resetPlayer();
                return;
            }
            
            // Проверка платформ
            let onPlatform = false;
            for (const platform of platforms) {
                const platformX = platform.x - levelProgress;
                
                if (
                    player.x < platformX + platform.width &&
                    player.x + player.width > platformX &&
                    player.y + player.height >= platform.y &&
                    player.y + player.height <= platform.y + 20 &&
                    player.velocityY > 0
                ) {
                    player.y = platform.y - player.height;
                    player.velocityY = 0;
                    onPlatform = true;
                    player.isJumping = false;
                    break;
                }
            }
            
            // Если не на платформе и падает - прыжок окончен
            if (!onPlatform && player.velocityY > 0) {
                player.isJumping = false;
            }
        }
        
        function checkCollisions() {
            // Монеты
            for (let i = coinsList.length - 1; i >= 0; i--) {
                const coin = coinsList[i];
                const coinX = coin.x - levelProgress;
                
                if (
                    player.x < coinX + 30 &&
                    player.x + player.width > coinX &&
                    player.y < coin.y + 30 &&
                    player.y + player.height > coin.y
                ) {
                    coinsList.splice(i, 1);
                    collectCoin();
                }
            }
            
            // Препятствия
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obstacle = obstacles[i];
                const obstacleX = obstacle.x - levelProgress;
                
                if (
                    player.x < obstacleX + obstacle.width &&
                    player.x + player.width > obstacleX &&
                    player.y < obstacle.y + obstacle.height &&
                    player.y + player.height > obstacle.y
                ) {
                    if (isPowerActive) {
                        obstacles.splice(i, 1);
                    } else {
                        loseLife();
                        player.velocityY = -10;
                        if (player.x > 50) player.x -= 50;
                    }
                    break;
                }
            }
            
            // Суперсилы
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                const powerUpX = powerUp.x - levelProgress;
                
                if (
                    player.x < powerUpX + 40 &&
                    player.x + player.width > powerUpX &&
                    player.y < powerUp.y + 40 &&
                    player.y + player.height > powerUp.y
                ) {
                    powerUps.splice(i, 1);
                    activatePowerUp(powerUp.type);
                }
            }
        }
        
        function collectCoin() {
            coins += 10 * combo;
            document.getElementById('coins-value').textContent = coins;
            
            combo++;
            document.getElementById('combo-count').textContent = `x${combo}`;
            comboTime = Date.now();
            document.getElementById('combo-container').style.opacity = '1';
            
            if (combo > maxCombo) {
                maxCombo = combo;
            }
            
            // Анимация
            document.getElementById('coins-stat').classList.add('bounce');
            setTimeout(() => {
                document.getElementById('coins-stat').classList.remove('bounce');
            }, 300);
            
            // Звук (симулируем)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                setTimeout(() => oscillator.stop(), 100);
            } catch(e) {
                // Пропускаем если AudioContext не поддерживается
            }
        }
        
        function loseLife() {
            lives--;
            document.getElementById('lives-value').textContent = lives;
            
            // Анимация
            document.getElementById('lives-stat').classList.add('shake');
            setTimeout(() => {
                document.getElementById('lives-stat').classList.remove('shake');
            }, 300);
            
            // Сброс комбо
            combo = 1;
            document.getElementById('combo-count').textContent = `x${combo}`;
            document.getElementById('combo-container').style.opacity = '0';
            
            if (lives <= 0) {
                gameOver();
            }
        }
        
        function resetPlayer() {
            player.y = player.groundY;
            player.velocityY = 0;
            player.isJumping = false;
        }
        
        function activatePowerUp(type) {
            isPowerActive = true;
            powerActiveTime = Date.now();
            power = 100;
            document.getElementById('power-value').textContent = '100%';
            document.getElementById('power-stat').classList.add('power-active');
            
            if (type === 'superJump') {
                player.jumpForce = -25;
            }
            
            // Звук
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 1200;
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                setTimeout(() => oscillator.stop(), 200);
            } catch(e) {}
        }
        
        function updatePowerUp() {
            if (isPowerActive) {
                const timePassed = Date.now() - powerActiveTime;
                power = Math.max(0, 100 - timePassed / 50); // 5 секунд
                document.getElementById('power-value').textContent = `${Math.round(power)}%`;
                
                if (power <= 0) {
                    isPowerActive = false;
                    player.jumpForce = -16;
                    document.getElementById('power-stat').classList.remove('power-active');
                }
            }
        }
        
        function updateCombo() {
            if (combo > 1 && Date.now() - comboTime > 2000) {
                combo = 1;
                document.getElementById('combo-count').textContent = `x${combo}`;
                document.getElementById('combo-container').style.opacity = '0';
            }
        }
        
        function gameOver() {
            gameState = 'gameover';
            document.getElementById('final-level').textContent = currentLevel;
            document.getElementById('final-coins').textContent = coins;
            document.getElementById('gameover-coins').textContent = coins;
            document.getElementById('max-combo').textContent = `x${maxCombo}`;
            
            document.getElementById('game-over').style.opacity = '1';
            document.getElementById('game-over').style.pointerEvents = 'auto';
        }
        
        function completeLevel() {
            gameState = 'levelcomplete';
            document.getElementById('completed-level').textContent = currentLevel;
            document.getElementById('level-coins').textContent = coins;
            document.getElementById('level-score').textContent = coins * combo;
            
            document.getElementById('level-complete').style.opacity = '1';
            document.getElementById('level-complete').style.pointerEvents = 'auto';
        }
        
        // Игровой цикл
        function gameLoop() {
            if (gameState === 'playing') {
                // Обновление
                updatePlayer();
                checkCollisions();
                updatePowerUp();
                updateCombo();
                
                // Прогресс уровня
                levelProgress += gameSpeed;
                if (levelProgress >= levelLength) {
                    completeLevel();
                }
                
                // Отрисовка
                drawBackground();
                drawPlatforms();
                drawCoins();
                drawObstacles();
                drawPowerUps();
                drawPlayer();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Управление
        function jump() {
            if (gameState === 'playing') {
                player.velocityY = player.jumpForce;
                player.isJumping = true;
            }
        }
        
        function startGame() {
            coins = 0;
            lives = 3;
            power = 0;
            combo = 1;
            maxCombo = 1;
            
            document.getElementById('coins-value').textContent = coins;
            document.getElementById('lives-value').textContent = lives;
            document.getElementById('power-value').textContent = '0%';
            document.getElementById('combo-count').textContent = `x${combo}`;
            document.getElementById('combo-container').style.opacity = '0';
            
            if (!initLevel(1)) return;
            
            document.getElementById('game-start').style.opacity = '0';
            document.getElementById('game-start').style.pointerEvents = 'none';
            gameState = 'playing';
        }
        
        function restartGame() {
            document.getElementById('game-over').style.opacity = '0';
            document.getElementById('game-over').style.pointerEvents = 'none';
            startGame();
        }
        
        function nextLevel() {
            document.getElementById('level-complete').style.opacity = '0';
            document.getElementById('level-complete').style.pointerEvents = 'none';
            
            if (!initLevel(currentLevel + 1)) {
                // Все уровни пройдены
                gameState = 'start';
                document.getElementById('game-start').style.opacity = '1';
                document.getElementById('game-start').style.pointerEvents = 'auto';
                return;
            }
            
            gameState = 'playing';
        }
        
        function returnToMenu() {
            document.getElementById('game-over').style.opacity = '0';
            document.getElementById('game-over').style.pointerEvents = 'none';
            document.getElementById('level-complete').style.opacity = '0';
            document.getElementById('level-complete').style.pointerEvents = 'none';
            
            document.getElementById('game-start').style.opacity = '1';
            document.getElementById('game-start').style.pointerEvents = 'auto';
            gameState = 'start';
            
            // Обновляем статистику в меню
            document.getElementById('total-levels').textContent = levels.length;
            document.getElementById('total-coins').textContent = coins;
        }
        
        function togglePause() {
            if (gameState === 'playing') {
                gameState = 'paused';
                document.getElementById('pause-btn').innerHTML = '<i class="fas fa-play"></i>';
            } else if (gameState === 'paused') {
                gameState = 'playing';
                document.getElementById('pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
            }
        }
        
        // Инициализация
        window.addEventListener('load', () => {
            resizeCanvas();
            document.getElementById('total-levels').textContent = levels.length;
            
            // Устанавливаем начальную высоту игрока
            player.y = canvas.height - 100 - player.height;
            player.groundY = player.y;
            
            // Запускаем игровой цикл
            gameLoop();
        });
        
        window.addEventListener('resize', resizeCanvas);
        
        // Обработчики событий
        document.getElementById('start-btn').addEventListener('click', startGame);
        document.getElementById('restart-btn').addEventListener('click', restartGame);
        document.getElementById('next-level-btn').addEventListener('click', nextLevel);
        document.getElementById('menu-btn').addEventListener('click', returnToMenu);
        document.getElementById('level-menu-btn').addEventListener('click', returnToMenu);
        document.getElementById('pause-btn').addEventListener('click', togglePause);
        document.getElementById('levels-btn').addEventListener('click', () => {
            alert(`В игре ${levels.length} уровня. Текущий уровень: ${currentLevel}`);
        });
        
        // Управление
        canvas.addEventListener('click', jump);
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            jump();
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') {
                jump();
            }
        });
    </script>
</body>
</html>