<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Matrix Checker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <input type="text" id="inputField" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç">
    <textarea id="outputField" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –∑–¥–µ—Å—å"></textarea>
    <input type="button" id="saveButton" value="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">
    <ol id="resultsList" class="gradient-list"></ol>

    <script>
        async function checkDataMatrix(dataCodes) {
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

            for (let index = 0; index < dataCodes.length; index++) {
                const code = dataCodes[index];
                const baseUrl = "https://mobile.api.crpt.ru/mobile/check";
                const encodedCode = encodeURIComponent(code);
                const url = `${baseUrl}?code=${encodedCode}&codeType=datamatrix`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ');
                    }
                    const data = await response.json();
                    const infoMsg = [data.code || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–æ–¥'];

                    if (data.codeFounded) {
                        const status = data.tiresData?.status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å';
                        const statusMessages = {
                            'INTRODUCED': '–í –æ–±–æ—Ä–æ—Ç–µ ‚úÖ',
                            'RETIRED': '–í—ã–±—ã–ª –∏–∑ –æ–±–æ—Ä–æ—Ç–∞ ‚ùå',
                            'EMITTED': '–≠–º–∏—Ç–∏—Ä–æ–≤–∞–Ω, –≤—ã–ø—É—â–µ–Ω ‚úîÔ∏è',
                            'APPLIED': '–≠–º–∏—Ç–∏—Ä–æ–≤–∞–Ω, –ø–æ–ª—É—á–µ–Ω üîó',
                            'WRITTEN_OFF': '–ö–ò —Å–ø–∏—Å–∞–Ω üü•',
                            'DISAGGREGATION': '–†–∞—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è —É–ø–∞–∫–æ–≤–æ–∫) üì¶üü•'
                        };
                        infoMsg.push(statusMessages[status] || `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∫–æ–¥–∞ ‚ö†Ô∏è [${status}]`);
                        const productName = data.productName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç';
                        infoMsg.push(`<b>[${productName}]</b>`);
                    } else {
                        infoMsg.push('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚ùó');
                    }

                    const resultItem = document.createElement('li');
                    resultItem.innerHTML = `${infoMsg.join('<br>')}`;
                    resultsList.appendChild(resultItem);
                } catch (error) {
                    const resultItem = document.createElement('li');
                    resultItem.innerHTML = `${index + 1}/${dataCodes.length}<br>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${error.message}`;
                    resultsList.appendChild(resultItem);
                }
            }
        }

        document.getElementById('inputField').addEventListener('input', async function() {
            const inputValue = this.value;
            const dataCodes = inputValue.split('\n');
            await checkDataMatrix(dataCodes);

            const outputField = document.getElementById('outputField');
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∫ —Ç–µ–∫—É—â–µ–º—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É textarea
            outputField.value += dataCodes.join('\n') + '\n';

            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
            this.value = '';
        });

        document.getElementById('saveButton').addEventListener('click', function() {
            const outputField = document.getElementById('outputField');
            const text = outputField.value;

            // –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–µ–π –∫–Ω–∏–≥–∏ –∏ –ª–∏—Å—Ç–∞
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(text.split('\n').map(line => [line]));

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Å—Ç–∞ –≤ —Ä–∞–±–æ—á—É—é –∫–Ω–∏–≥—É
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–π –∫–Ω–∏–≥–∏ –≤ —Ñ–∞–π–ª
            XLSX.writeFile(wb, 'result.xlsx');
        });
    </script>
</body>
</html>
